# Electron IPC æœ€ä½³å®è·µæ¼”ç¤º

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Electron åº”ç”¨ï¼Œå±•ç¤ºäº†è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æœ€ä½³å®è·µå’Œå®‰å…¨è®¾è®¡æ¨¡å¼ã€‚

## ğŸš€ ç‰¹æ€§

- **å®‰å…¨çš„ä¸Šä¸‹æ–‡éš”ç¦»**: å¯ç”¨ `contextIsolation`ï¼Œç¦ç”¨ `nodeIntegration`
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **ç»Ÿä¸€çš„é€šé“ç®¡ç†**: é›†ä¸­åŒ–çš„ IPC é€šé“å®šä¹‰
- **è¾“å…¥éªŒè¯**: ä½¿ç”¨ Zod è¿›è¡Œæ•°æ®æ ¡éªŒ
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **å®æ—¶äº‹ä»¶**: åŒå‘äº‹ä»¶é€šä¿¡å’Œå¹¿æ’­
- **é«˜çº§åŠŸèƒ½**: ç¼“å­˜ã€é˜Ÿåˆ—ç®¡ç†ã€æ‰¹é‡å¤„ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ common/
â”‚   â””â”€â”€ ipc.ts              # IPC é€šé“å’Œç±»å‹å®šä¹‰
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ user.ts        # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ file.ts        # æ–‡ä»¶æ“ä½œæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ system.ts      # ç³»ç»Ÿä¿¡æ¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ task.ts        # ä»»åŠ¡ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ ipc/
â”‚       â””â”€â”€ handlers.ts     # IPC å¤„ç†å™¨æ³¨å†Œ
â”œâ”€â”€ preload.ts              # å®‰å…¨æ¡¥æ¥å±‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ipcHelper.ts        # IPC å·¥å…·å‡½æ•°
â”œâ”€â”€ components/             # React æ¼”ç¤ºç»„ä»¶
â”‚   â”œâ”€â”€ UserDemo.tsx       # ç”¨æˆ·ç®¡ç†æ¼”ç¤º
â”‚   â”œâ”€â”€ FileDemo.tsx       # æ–‡ä»¶æ“ä½œæ¼”ç¤º
â”‚   â”œâ”€â”€ SystemDemo.tsx     # ç³»ç»Ÿä¿¡æ¯æ¼”ç¤º
â”‚   â”œâ”€â”€ TaskDemo.tsx       # ä»»åŠ¡ç®¡ç†æ¼”ç¤º
â”‚   â”œâ”€â”€ AdvancedDemo.tsx   # é«˜çº§åŠŸèƒ½æ¼”ç¤º
â”‚   â””â”€â”€ LogViewer.tsx      # æ—¥å¿—æŸ¥çœ‹å™¨
â””â”€â”€ App.tsx                 # ä¸»åº”ç”¨ç»„ä»¶
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. ä¸‰å±‚æ¶æ„

```
Renderer Process â†’ Preload Script â†’ Main Process
     (React)    â†’   (Bridge)     â†’   (Node.js)
```

- **Renderer**: ç”¨æˆ·ç•Œé¢ï¼Œåªèƒ½é€šè¿‡ preload æš´éœ²çš„ API ä¸ä¸»è¿›ç¨‹é€šä¿¡
- **Preload**: å®‰å…¨æ¡¥æ¥å±‚ï¼Œæš´éœ²ç±»å‹å®‰å…¨çš„å‡½æ•°è€ŒéåŸå§‹ IPC é€šé“
- **Main**: ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ŒåŒ…å«æœåŠ¡å±‚å’Œ IPC å¤„ç†å™¨

### 2. é€šé“ç®¡ç†

æ‰€æœ‰ IPC é€šé“åœ¨ `src/common/ipc.ts` ä¸­é›†ä¸­å®šä¹‰ï¼š

```typescript
export const IPC = {
  user: {
    getById: 'user:getById',
    create: 'user:create',
    // ...
  },
  // ...
} as const;
```

### 3. ç±»å‹å®‰å…¨

å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰ç¡®ä¿ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼š

```typescript
interface CreateUserReq {
  name: string;
  email: string;
  role: 'admin' | 'user';
}

interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  timestamp: number;
}
```

## ğŸ› ï¸ ä¸»è¦åŠŸèƒ½

### ç”¨æˆ·ç®¡ç† (CRUD)
- åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ç”¨æˆ·
- å®æ—¶äº‹ä»¶é€šçŸ¥ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
- è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†

### æ–‡ä»¶æ“ä½œ
- å®‰å…¨çš„æ–‡ä»¶è¯»å†™ï¼ˆè·¯å¾„éªŒè¯ï¼‰
- è¿›åº¦ç›‘æ§
- æ”¯æŒä¸åŒç¼–ç æ ¼å¼

### ç³»ç»Ÿä¿¡æ¯
- è·å–ç³»ç»Ÿç¡¬ä»¶ä¿¡æ¯
- æ‰“å¼€æ–‡ä»¶å¤¹
- æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥

### ä»»åŠ¡ç®¡ç†
- å¼‚æ­¥ä»»åŠ¡åˆ›å»ºå’Œæ‰§è¡Œ
- å®æ—¶è¿›åº¦æ›´æ–°
- ä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼ˆè¿›è¡Œä¸­ã€å®Œæˆã€å¤±è´¥ã€å–æ¶ˆï¼‰

### é«˜çº§åŠŸèƒ½
- **é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿
- **æ‰¹é‡å¤„ç†**: å¹¶å‘æ§åˆ¶çš„æ‰¹é‡ IPC è°ƒç”¨
- **ç¼“å­˜ç³»ç»Ÿ**: TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰ç¼“å­˜
- **é˜Ÿåˆ—ç®¡ç†**: ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œå¹¶å‘æ§åˆ¶

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **ä¸Šä¸‹æ–‡éš”ç¦»**: `contextIsolation: true`
2. **Node.js éš”ç¦»**: `nodeIntegration: false`
3. **è¾“å…¥éªŒè¯**: ä½¿ç”¨ Zod schema éªŒè¯æ‰€æœ‰è¾“å…¥
4. **è·¯å¾„å®‰å…¨**: æ–‡ä»¶æ“ä½œé™åˆ¶åœ¨å®‰å…¨ç›®å½•å†…
5. **API é—¨é¢**: ä¸æš´éœ²åŸå§‹ IPC é€šé“ï¼Œåªæš´éœ²å‡½æ•°

## ğŸš€ è¿è¡Œé¡¹ç›®

1. å®‰è£…ä¾èµ–ï¼š
```bash
npm install
```

2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
```bash
npm start
```

3. æ‰“åŒ…åº”ç”¨ï¼š
```bash
npm run package
```

## ğŸ“Š æ¼”ç¤ºåŠŸèƒ½

åº”ç”¨åŒ…å«ä»¥ä¸‹æ¼”ç¤ºæ¨¡å—ï¼š

1. **ç”¨æˆ·ç®¡ç†**: å±•ç¤º CRUD æ“ä½œå’Œå®æ—¶äº‹ä»¶
2. **æ–‡ä»¶æ“ä½œ**: å®‰å…¨çš„æ–‡ä»¶è¯»å†™å’Œè¿›åº¦ç›‘æ§
3. **ç³»ç»Ÿä¿¡æ¯**: ç³»ç»Ÿä¿¡æ¯è·å–å’Œç³»ç»ŸåŠŸèƒ½è°ƒç”¨
4. **ä»»åŠ¡ç®¡ç†**: é•¿æ—¶é—´è¿è¡Œä»»åŠ¡çš„ç®¡ç†å’Œç›‘æ§
5. **é«˜çº§åŠŸèƒ½**: é”™è¯¯å¤„ç†ã€é‡è¯•ã€ç¼“å­˜ç­‰é«˜çº§ç‰¹æ€§

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### æ·»åŠ æ–°çš„ IPC åŠŸèƒ½

1. **å®šä¹‰ç±»å‹å’Œé€šé“** (`src/common/ipc.ts`)ï¼š
```typescript
export const IPC = {
  // ç°æœ‰å®šä¹‰...
  newFeature: {
    action: 'newFeature:action',
  },
};

export interface NewFeatureReq {
  param: string;
}
```

2. **åˆ›å»ºæœåŠ¡** (`src/main/services/newFeature.ts`)ï¼š
```typescript
export const newFeatureService = {
  async performAction(param: string) {
    // ä¸šåŠ¡é€»è¾‘
    return result;
  },
};
```

3. **æ³¨å†Œå¤„ç†å™¨** (`src/main/ipc/handlers.ts`)ï¼š
```typescript
ipcMain.handle(
  IPC.newFeature.action,
  safeHandler(NewFeatureReqSchema, async (req: NewFeatureReq) => {
    return await newFeatureService.performAction(req.param);
  })
);
```

4. **æš´éœ² API** (`src/preload.ts`)ï¼š
```typescript
const api = {
  // ç°æœ‰ API...
  newFeature: {
    async action(param: string) {
      return invokeWithTimeout(IPC.newFeature.action, { param });
    },
  },
};
```

5. **åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ä½¿ç”¨**ï¼š
```typescript
const result = await window.electronAPI.newFeature.action('test');
```

## ğŸ“š æœ€ä½³å®è·µ

1. **å§‹ç»ˆä½¿ç”¨ç±»å‹å®‰å…¨çš„ API**ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ `ipcRenderer`
2. **é›†ä¸­ç®¡ç†é€šé“åç§°**ï¼Œé¿å…é­”æ³•å­—ç¬¦ä¸²
3. **éªŒè¯æ‰€æœ‰è¾“å…¥**ï¼Œä½¿ç”¨ Zod æˆ–ç±»ä¼¼åº“
4. **å¦¥å–„å¤„ç†é”™è¯¯**ï¼Œæä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
5. **æ¸…ç†äº‹ä»¶ç›‘å¬å™¨**ï¼Œé¿å…å†…å­˜æ³„æ¼
6. **ä½¿ç”¨ç¼“å­˜å’Œé‡è¯•**ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ
7. **é™åˆ¶æ–‡ä»¶è®¿é—®**ï¼Œåªå…è®¸è®¿é—®å®‰å…¨ç›®å½•

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªæ¼”ç¤ºé¡¹ç›®ã€‚

## ğŸ“„ è®¸å¯è¯

MIT License
